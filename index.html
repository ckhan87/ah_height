<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿ç±³èº«é«˜ç®¡ç† (Google Calendar åŒæ­¥ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Chart Sizing */
        .chart-container { position: relative; width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .nav-tab { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.3s ease; white-space: nowrap; font-size: 0.85rem; }
        .nav-tab.active { border-bottom: 3px solid #0ea5e9; color: #0ea5e9; font-weight: 700; }

        /* Full Screen Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
            z-index: 100; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease-out; }
        .modal-content {
            background: white; width: 95%; max-width: 800px; height: 90%;
            border-radius: 16px; display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }
        
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db;
            width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased pb-24">

    <!-- Top Bar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="flex justify-between items-center px-4 h-14">
            <div class="font-bold text-sky-600 text-lg">AhMi<span class="text-slate-600">Growth</span> <span class="text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full align-middle">G-Cal Sync</span></div>
            <div class="flex gap-2">
                <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-sky-600">âš™ï¸</button>
            </div>
        </div>
        
        <div class="flex text-sm font-medium border-t border-slate-100 bg-white shadow-sm overflow-x-auto scrollbar-hide">
            <button onclick="switchMainTab('tracker')" id="nav-tracker" class="nav-tab active flex-1 py-3 px-4 text-center">ğŸ“Š è¿½è¸ª</button>
            <button onclick="switchMainTab('health')" id="nav-health" class="nav-tab flex-1 py-3 px-4 text-center">ğŸ¥ å¥åº·</button>
            <button onclick="switchMainTab('stretch')" id="nav-stretch" class="nav-tab flex-1 py-3 px-4 text-center">ğŸ§˜ æ‹‰ä¼¸</button>
            <button onclick="switchMainTab('ai-diet')" id="nav-ai-diet" class="nav-tab flex-1 py-3 px-4 text-center">ğŸ½ï¸ é£Ÿè°±</button>
            <button onclick="switchMainTab('routine')" id="nav-routine" class="nav-tab flex-1 py-3 px-4 text-center">ğŸ“… æ—¥ç¨‹</button>
        </div>

        <!-- Hidden Settings -->
        <div id="settings-panel" class="hidden absolute left-0 right-0 top-14 bg-white border-b border-slate-200 shadow-xl p-4 z-40">
            <p class="text-xs text-green-600 font-bold mb-2">âœ“ ç³»ç»Ÿå·²å†…ç½®æ‚¨çš„ä¸“å± API Key</p>
            <input type="password" id="apiKeyInput" placeholder="æ‰‹åŠ¨ Key (å¯é€‰)" class="w-full p-2 border border-slate-300 rounded mb-2 text-sm">
            <div class="flex gap-2">
                <button onclick="saveApiKey()" class="flex-1 bg-sky-600 text-white py-2 rounded text-sm">æ›´æ–°</button>
                <button onclick="toggleSettings()" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded text-sm">å…³é—­</button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-6">

        <!-- ========================= TAB 1: TRACKER ========================= -->
        <div id="view-tracker" class="space-y-6 animate-fade-in">
            <!-- AI Control Center -->
            <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-xl p-5 text-white shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-bold">ğŸ¤– AI ç”Ÿé•¿é¡¾é—®</h2>
                        <p class="text-xs text-indigo-100 opacity-90">åŸºäº Simpang Ampat ç¯å¢ƒ & é—ä¼ æ•°æ®</p>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-[10px] font-bold">ç›®æ ‡ 185cm</div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="askGeminiReport('progress')" id="btn-progress" class="bg-white text-indigo-700 hover:bg-indigo-50 py-3 rounded-lg font-bold shadow-md text-sm flex flex-col items-center justify-center gap-1 transition active:scale-95">
                        <span class="text-xl">ğŸ“ˆ</span>
                        <span>åˆ†æè¿›åº¦æŠ¥å‘Š</span>
                        <span class="text-[9px] text-indigo-400 font-normal">åŒè¯­ â€¢ æ·±åº¦åˆ†æ</span>
                    </button>
                    <button onclick="askGeminiReport('rescue')" id="btn-rescue" class="bg-rose-500 text-white hover:bg-rose-600 py-3 rounded-lg font-bold shadow-md text-sm flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-rose-400">
                        <span class="text-xl">ğŸš€</span>
                        <span>å¿«é€Ÿè¡¥æ•‘å»ºè®®</span>
                        <span class="text-[9px] text-rose-100 font-normal">è½åè¿½èµ¶ â€¢ ç´§æ€¥æ–¹æ¡ˆ</span>
                    </button>
                </div>
            </div>

            <!-- Input Card -->
            <div class="glass-panel p-4 rounded-xl border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-slate-900">ğŸ“ æ•°æ®å½•å…¥</h2>
                    <span id="currentDateDisplay" class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500"></span>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <div><label class="text-[10px] text-slate-500 uppercase">æ—¥æœŸ</label><input type="date" id="recordDate" class="w-full p-2 border rounded text-sm"></div>
                    <div><label class="text-[10px] text-slate-500 uppercase">èº«é«˜ (cm)</label><input type="number" id="recordHeight" step="0.1" placeholder="110" class="w-full p-2 border rounded text-sm font-bold text-indigo-600"></div>
                    <div><label class="text-[10px] text-slate-500 uppercase">ä½“é‡ (kg)</label><input type="number" id="recordWeight" step="0.1" placeholder="18" class="w-full p-2 border rounded text-sm"></div>
                </div>
                <button onclick="addRecord()" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold shadow text-sm flex justify-center items-center gap-2">
                    <span>ä¿å­˜å¹¶åŒæ­¥ Google Calendar</span>
                    <span class="text-xs bg-white/20 px-1 rounded">â˜ï¸</span>
                </button>
            </div>

            <!-- Charts -->
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-2">ğŸ“ èº«é«˜æ›²çº¿</h3>
                <div class="chart-container"><canvas id="growthChart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-2">âš–ï¸ ä½“é‡æ›²çº¿</h3>
                <div class="chart-container"><canvas id="weightChart"></canvas></div>
            </div>
            
            <!-- History Table -->
            <div class="glass-panel rounded-xl overflow-hidden border border-slate-200">
                <div class="bg-slate-50 px-4 py-2 text-sm font-bold text-slate-700 flex justify-between">
                    <span>å†å²è®°å½•</span>
                    <span class="text-xs font-normal text-slate-400">ç‚¹å‡» ğŸ“… å›¾æ ‡è¡¥ä¼ æ—¥å†</span>
                </div>
                <div class="max-h-56 overflow-y-auto">
                    <table class="w-full text-xs text-left" id="recordsTableBody"></table>
                </div>
            </div>
        </div>

        <!-- ========================= TAB 2: HEALTH ========================= -->
        <div id="view-health" class="space-y-6 hidden animate-fade-in">
            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                <h2 class="font-bold text-red-800 mb-2">ğŸ¤’ ç”Ÿç—…è®°å½•ä»ª</h2>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="text-[10px] text-slate-500 uppercase">å¼€å§‹</label><input type="date" id="sickStartDate" class="w-full p-2 border border-red-200 rounded text-sm bg-white"></div>
                    <div><label class="text-[10px] text-slate-500 uppercase">åº·å¤</label><input type="date" id="sickEndDate" class="w-full p-2 border border-red-200 rounded text-sm bg-white"></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <label class="cursor-pointer"><input type="checkbox" class="hidden symptom-checkbox" value="å’³å—½"><div class="p-2 border border-slate-200 rounded text-center text-sm text-slate-600 bg-white hover:bg-slate-50">ğŸ˜· å’³å—½</div></label>
                    <label class="cursor-pointer"><input type="checkbox" class="hidden symptom-checkbox" value="æµé¼»æ¶•"><div class="p-2 border border-slate-200 rounded text-center text-sm text-slate-600 bg-white hover:bg-slate-50">ğŸ¤§ æµé¼»æ¶•</div></label>
                    <label class="cursor-pointer"><input type="checkbox" class="hidden symptom-checkbox" value="å‘çƒ§"><div class="p-2 border border-slate-200 rounded text-center text-sm text-slate-600 bg-white hover:bg-slate-50">ğŸ¤’ å‘çƒ§</div></label>
                    <label class="cursor-pointer"><input type="checkbox" class="hidden symptom-checkbox" value="é¼»å¡"><div class="p-2 border border-slate-200 rounded text-center text-sm text-slate-600 bg-white hover:bg-slate-50">ğŸ‘ƒ é¼»å¡</div></label>
                </div>
                <button onclick="addSickRecord()" class="w-full bg-red-500 text-white py-2 rounded-lg font-bold shadow text-sm flex justify-center items-center gap-2">
                    <span>ä¿å­˜å¹¶åŒæ­¥ Google Calendar</span>
                    <span class="text-xs bg-white/20 px-1 rounded">â˜ï¸</span>
                </button>
            </div>
            <div class="glass-panel rounded-xl overflow-hidden border border-slate-200">
                <div class="bg-slate-50 px-4 py-2 text-sm font-bold text-slate-700">å†å²è®°å½•</div>
                <div id="sickRecordsList" class="divide-y divide-slate-100 max-h-80 overflow-y-auto bg-white"></div>
            </div>
        </div>

        <!-- ========================= TAB 3: STRETCH ========================= -->
        <div id="view-stretch" class="space-y-6 hidden animate-fade-in">
            <div class="bg-gradient-to-r from-orange-400 to-amber-500 rounded-xl p-5 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-1">ğŸ§˜ æ¯æ—¥æ‹‰ä¼¸</h2>
                <p class="text-xs text-orange-100">ç¡å‰5åˆ†é’Ÿ = 10å€ç”Ÿé•¿æ¿€ç´ </p>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="bg-amber-50 p-3 border-b border-amber-100"><h3 class="font-bold text-amber-800 text-sm">â˜€ï¸ ç¡é†’å”¤é†’</h3></div>
                <div class="p-4 space-y-4">
                    <div class="flex gap-3"><span class="bg-amber-100 text-amber-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</span><p class="text-xs text-slate-600"><strong>å…¨èº«å»¶å±•:</strong> èººåœ¨åºŠä¸Šï¼Œæ‰‹è„šå‘ç›¸åæ–¹å‘ç”¨åŠ›æ‹‰ä¼¸ 10ç§’ã€‚</p></div>
                    <div class="flex gap-3"><span class="bg-amber-100 text-amber-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</span><p class="text-xs text-slate-600"><strong>ä¾§å¼¯æ‹‰ä¼¸:</strong> ç«™ç«‹ï¼ŒåŒæ‰‹åˆåä¸¾è¿‡å¤´ï¼Œå‘å·¦å³å¼¯è…°æˆCå­—ã€‚</p></div>
                </div>
            </div>
            <div class="glass-panel p-4 rounded-xl border border-orange-200">
                <h3 class="font-bold text-slate-800 text-sm mb-2">ğŸ¤– AI è¿åŠ¨å»ºè®®</h3>
                <div class="flex gap-2 mb-2">
                    <button onclick="askStretch('fun')" class="flex-1 bg-orange-100 text-orange-700 py-2 rounded text-xs">ğŸ® è¶£å‘³ç‰ˆ</button>
                    <button onclick="askStretch('sore')" class="flex-1 bg-orange-100 text-orange-700 py-2 rounded text-xs">ğŸ¦µ èˆ’ç¼“ç‰ˆ</button>
                </div>
                <div id="stretchResult" class="hidden text-xs text-slate-600 bg-white p-3 rounded border border-slate-200"></div>
            </div>
        </div>

        <!-- ========================= TAB 4 & 5: DIET & ROUTINE ========================= -->
        <div id="view-ai-diet" class="space-y-6 hidden animate-fade-in">
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl p-6 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-2">ğŸ½ï¸ AI åŠ©é•¿é£Ÿè°±</h2>
                <button onclick="generateMealPlan()" id="btnGenMeal" class="w-full bg-white text-emerald-700 py-3 rounded-lg font-bold shadow-md flex justify-center items-center gap-2"><span>âœ¨ ç”Ÿæˆä»Šæ—¥å»ºè®®</span></button>
            </div>
            <div id="mealPlanResult" class="hidden glass-panel p-5 rounded-xl border border-slate-200 prose prose-sm max-w-none prose-emerald"><div id="mealContent" class="text-slate-700"></div></div>
        </div>

        <div id="view-routine" class="space-y-6 hidden animate-fade-in">
            <div class="bg-indigo-600 rounded-xl p-6 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-2">ğŸ“… æ™ºèƒ½æ—¥ç¨‹</h2>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="generateSchedule('normal')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ« ä¸Šå­¦æ—¥</button>
                    <button onclick="generateSchedule('weekend')" class="bg-indigo-500 py-2 rounded text-xs">âš½ å‘¨æœ«</button>
                    <button onclick="generateSchedule('exam')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ“š è€ƒè¯•</button>
                    <button onclick="generateSchedule('sick')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ¤’ ç”Ÿç—…</button>
                </div>
                <div id="scheduleResult" class="hidden mt-4 bg-white text-slate-800 p-4 rounded-lg text-sm leading-relaxed max-h-64 overflow-y-auto"></div>
            </div>
        </div>

        <!-- ========================= FULL SCREEN MODAL ========================= -->
        <div id="fullScreenModal" class="modal-overlay">
            <div class="modal-content">
                <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                    <h2 id="modalTitle" class="text-xl font-bold text-slate-800">AI æŠ¥å‘Š</h2>
                    <button onclick="closeModal('fullScreenModal')" class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 hover:bg-slate-300">âœ•</button>
                </div>
                <div id="modalBody" class="p-6 overflow-y-auto flex-1 bg-white prose prose-lg prose-indigo max-w-none"></div>
                <div class="px-6 py-3 border-t border-slate-200 bg-slate-50 flex justify-end">
                    <button onclick="closeModal('fullScreenModal')" class="px-6 py-2 bg-slate-800 text-white rounded-lg font-medium text-sm">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- ========================= GOOGLE CALENDAR SYNC MODAL ========================= -->
        <div id="gcalModal" class="modal-overlay">
            <div class="modal-content h-auto">
                <div class="px-6 py-4 border-b border-slate-200 bg-green-50">
                    <h2 class="text-lg font-bold text-green-800">ğŸ“… æ·»åŠ åˆ° Google Calendar</h2>
                </div>
                <div class="p-6 bg-white text-sm text-slate-600">
                    <p class="mb-4">æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚</p>
                    <p class="mb-4">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†æ‰“å¼€ Google Calendarï¼Œç›¸å…³æ•°æ®ï¼ˆèº«é«˜/ä½“é‡/ç—…æƒ…ï¼‰å·²è‡ªåŠ¨å¡«å¥½ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’çš„ <b>"Save" (ä¿å­˜)</b> å³å¯ã€‚</p>
                    <p class="text-xs text-slate-400">æç¤ºï¼šå¦‚æœæ‚¨æƒ³ä¸å¤ªå¤ªå…±äº«ï¼Œè¯·åœ¨ Google Calendar ä¸­æ·»åŠ å¥¹ä¸º"Guest" (å‚ä¸è€…)ã€‚</p>
                    <a id="gcalLink" href="#" target="_blank" class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg">
                        ğŸš€ ç«‹å³è·³è½¬åŒæ­¥
                    </a>
                </div>
                <div class="px-6 py-3 border-t border-slate-200 bg-slate-50 flex justify-end">
                    <button onclick="closeModal('gcalModal')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded text-sm">å…³é—­</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA & CONFIG ---
        const DEFAULT_API_KEY = "AIzaSyAUtEFAtS0XZOGOgU34583WU2i_MivtJ7s";
        const CHILD_BIRTH_DATE = new Date('2020-06-01');
        let records = [];
        let sickRecords = [];
        let myChart, weightChart;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
            document.getElementById('sickStartDate').value = today;
            document.getElementById('currentDateDisplay').innerText = today;

            loadRecords();
            loadSickRecords();
            initCharts();
            switchMainTab('tracker');
        });

        // --- GOOGLE CALENDAR LOGIC (WEB INTENTS) ---
        function openGCalModal(url) {
            document.getElementById('gcalLink').href = url;
            document.getElementById('gcalModal').classList.add('open');
        }

        function createGCalLink(title, startDate, endDate, description) {
            // Format dates for Google Calendar: YYYYMMDD
            const formatGCalDate = (dateStr) => dateStr.replace(/-/g, '');
            
            const start = formatGCalDate(startDate);
            // Google calendar end date is exclusive, so if single day, same as start. 
            // If sickness range, usually end date + 1 day needed, but for simple link keeping same is safer for simplicity or handle strictly.
            // For simple "All day", start=end works usually for single day events. 
            const end = endDate ? formatGCalDate(endDate) : start; 
            
            const baseUrl = "https://calendar.google.com/calendar/render?action=TEMPLATE";
            const params = new URLSearchParams();
            params.append('text', title);
            params.append('dates', `${start}/${end}`); // YYYYMMDD/YYYYMMDD
            params.append('details', description + "\n\n(Generated by AhMi Growth App)");
            params.append('sf', 'true');
            params.append('output', 'xml');
            
            return `${baseUrl}&${params.toString()}`;
        }

        // --- TRACKER LOGIC ---
        function loadRecords() {
            const stored = localStorage.getItem('ahmi_growth_records');
            records = stored ? JSON.parse(stored) : [{ id: 1, date: '2025-05-01', age: 5.5, height: 110, weight: 18 }];
            renderTable(); updateCharts();
        }

        function addRecord() {
            const date = document.getElementById('recordDate').value;
            const h = parseFloat(document.getElementById('recordHeight').value);
            const w = parseFloat(document.getElementById('recordWeight').value);
            if(!date || !h || !w) return alert('è¯·å¡«å†™');
            
            const age = (new Date(date) - CHILD_BIRTH_DATE) / (1000 * 60 * 60 * 24 * 365.25);
            const newRecord = {id:Date.now(), date, age: age.toFixed(1), height:h, weight:w};
            records.push(newRecord);
            localStorage.setItem('ahmi_growth_records', JSON.stringify(records)); 
            loadRecords();

            // Generate Sync Link
            const title = `ğŸ“ é˜¿ç±³: ${h}cm / ${w}kg`;
            const desc = `å¹´é¾„: ${age.toFixed(1)}å²\nBMI: ${(w/((h/100)**2)).toFixed(1)}\nç›®æ ‡: 185cm`;
            const link = createGCalLink(title, date, null, desc);
            
            // Ask to Sync
            openGCalModal(link);
        }

        function renderTable() {
            const tbody = document.getElementById('recordsTableBody'); tbody.innerHTML='';
            [...records].reverse().forEach(r => {
                const title = `ğŸ“ é˜¿ç±³: ${r.height}cm / ${r.weight}kg`;
                const desc = `å¹´é¾„: ${r.age}å²`;
                const link = createGCalLink(title, r.date, null, desc);
                
                tbody.innerHTML += `
                <tr class="border-b border-slate-50">
                    <td class="px-3 py-2">${r.date}</td>
                    <td class="px-3 py-2 font-bold text-indigo-600">${r.height}cm / ${r.weight}kg</td>
                    <td class="px-3 py-2 text-right">
                        <a href="${link}" target="_blank" class="text-green-500 hover:text-green-700 text-lg" title="åŒæ­¥åˆ° Google Calendar">ğŸ“…</a>
                    </td>
                </tr>`;
            });
        }

        // --- HEALTH LOGIC ---
        function loadSickRecords() {
            const stored = localStorage.getItem('ahmi_sick_records');
            if (stored) { sickRecords = JSON.parse(stored); sickRecords.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate)); }
            renderSickTable();
        }

        function addSickRecord() {
            const start = document.getElementById('sickStartDate').value;
            const end = document.getElementById('sickEndDate').value;
            const sym = []; document.querySelectorAll('.symptom-checkbox:checked').forEach(c=>sym.push(c.value));
            if(!start || sym.length===0) return alert('è¯·å¡«å†™');
            
            sickRecords.push({id:Date.now(), startDate:start, endDate:end||"æœªåº·å¤", symptoms:sym});
            localStorage.setItem('ahmi_sick_records', JSON.stringify(sickRecords)); loadSickRecords();
            document.querySelectorAll('.symptom-checkbox').forEach(c=>c.checked=false);

            // Generate Sync Link
            const title = `ğŸ¤’ é˜¿ç±³ç”Ÿç—…: ${sym.join(',')}`;
            // If has end date, use it. If not, just start date.
            // Note: Google Calendar dates range implies END date is exclusive +1 day for visual block, but standard intent works OK usually.
            const link = createGCalLink(title, start, end || start, "ç”Ÿç—…è®°å½•ã€‚è¯·æ³¨æ„ä¼‘æ¯å’Œè¥å…»è¡¥å……ã€‚");
            openGCalModal(link);
        }

        function renderSickTable() {
            const div = document.getElementById('sickRecordsList'); div.innerHTML='';
            if(sickRecords.length===0) return div.innerHTML='<div class="p-4 text-center text-xs text-slate-400">æš‚æ— ç”Ÿç—…è®°å½•</div>';
            sickRecords.forEach(r => {
                const title = `ğŸ¤’ é˜¿ç±³ç”Ÿç—…: ${r.symptoms.join(',')}`;
                const link = createGCalLink(title, r.startDate, r.endDate !== "æœªåº·å¤" ? r.endDate : r.startDate, "è¡¥ä¼ ç”Ÿç—…è®°å½•");
                
                div.innerHTML += `
                <div class="p-3 border-b border-slate-50 flex justify-between items-center">
                    <div class="text-xs">
                        <b>${r.startDate}</b> <span class="text-slate-400">è‡³</span> ${r.endDate} <br>
                        <span class="text-red-500">${r.symptoms.join(', ')}</span>
                    </div>
                    <div class="flex gap-3">
                        <a href="${link}" target="_blank" class="text-green-500 text-lg">ğŸ“…</a>
                        <button onclick="deleteSick(${r.id})" class="text-red-300 text-[10px]">Ã—</button>
                    </div>
                </div>`;
            });
        }

        // --- OTHER LOGIC (TABS, AI, CHARTS) ---
        function switchMainTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
            ['tracker', 'health', 'stretch', 'ai-diet', 'routine'].forEach(id => document.getElementById('view-' + id).classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');
            if(tabId === 'tracker') { if(myChart) myChart.resize(); if(weightChart) weightChart.resize(); }
        }
        function getApiKey() { return localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY; }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow = ''; }
        function openModal(title, text) { document.getElementById('modalTitle').innerText = title; document.getElementById('modalBody').innerHTML = marked.parse(text); document.getElementById('fullScreenModal').classList.add('open'); document.body.style.overflow = 'hidden'; }
        async function askGeminiReport(type) {
            if (records.length === 0) return alert("è¯·å…ˆå½•å…¥èº«é«˜ä½“é‡æ•°æ®");
            const apiKey = getApiKey();
            const latest = records[records.length - 1];
            const btnId = type === 'progress' ? 'btn-progress' : 'btn-rescue';
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>'; btn.disabled = true;
            let prompt = ""; let title = "";
            if (type === 'progress') { title = "ğŸ“ˆ åŒè¯­ç”Ÿé•¿è¿›åº¦æŠ¥å‘Š / Dual-Language Progress Report"; prompt = `Role: Pediatric Specialist. Child Age ${latest.age}, Height ${latest.height}cm, Weight ${latest.weight}kg. Target 185cm. Context: Penang. Task: Dual-language report (Chinese & English) analyzing percentile, BMI, and status. Markdown format.`; } 
            else { title = "ğŸš€ å¿«é€Ÿè¡¥æ•‘æ–¹æ¡ˆ / Quick Rescue Plan"; prompt = `Role: Growth Crisis Specialist. Child Age ${latest.age}, Height ${latest.height}cm, Weight ${latest.weight}kg. Target 185cm. Situation: Lagging growth. Task: Dual-language (Chinese & English) rescue plan focusing on Penang diet, sleep, and HIIT sports. Markdown format.`; }
            try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); const data = await response.json(); openModal(title, data.candidates[0].content.parts[0].text); } catch (e) { alert("AI Error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }
        function initCharts() {
            const ages = [5,6,7,8,9,10,11,12,13,14];
            myChart = new Chart(document.getElementById('growthChart'), { type:'line', data:{labels:ages, datasets:[{label:'å®æµ‹',data:[],borderColor:'#8b5cf6'}, {label:'ç›®æ ‡',data:[110,115,122,129,135,141,148,156,166,175],borderColor:'#0ea5e9',borderDash:[5,5]}]}, options:{maintainAspectRatio:false} });
            weightChart = new Chart(document.getElementById('weightChart'), { type:'line', data:{labels:ages, datasets:[{label:'å®æµ‹',data:[],borderColor:'#f59e0b'}, {label:'æ ‡å‡†',data:[18,20,23,25,28,32,36,40,45,50],borderColor:'#10b981',borderDash:[5,5]}]}, options:{maintainAspectRatio:false} });
        }
        function updateCharts() { if(!myChart)return; myChart.data.datasets[0].data=records.map(r=>r.height); myChart.update(); weightChart.data.datasets[0].data=records.map(r=>r.weight); weightChart.update(); }
        function deleteSick(id) { sickRecords=sickRecords.filter(r=>r.id!==id); localStorage.setItem('ahmi_sick_records', JSON.stringify(sickRecords)); renderSickTable(); }
        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function saveApiKey() { localStorage.setItem('gemini_api_key', document.getElementById('apiKeyInput').value); toggleSettings(); }
        // Generic AI
        async function callGeminiGeneric(prompt, outputContainer, btn) {
            const apiKey = getApiKey(); if(btn) { btn.disabled=true; btn.innerHTML='<div class="loader"></div>'; } outputContainer.classList.remove('hidden'); outputContainer.innerHTML = 'AI Thinking...';
            try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); const data = await response.json(); outputContainer.innerHTML = marked.parse(data.candidates[0].content.parts[0].text); } catch (e) { outputContainer.innerHTML = "Error."; } if(btn) { btn.disabled=false; btn.innerHTML='âœ¨ ç”Ÿæˆ'; }
        }
        function askStretch(type) { callGeminiGeneric(`Role: Kids Physio. Child 5.5yr. ${type==='fun'?'Fun game':'Sore relief'} stretching. Chinese.`, document.getElementById('stretchResult')); }
        function generateMealPlan() { callGeminiGeneric(`Role: Nutritionist. Child 5.5yr. Penang food. Meal Plan. Chinese.`, document.getElementById('mealContent'), document.getElementById('btnGenMeal')); document.getElementById('mealPlanResult').classList.remove('hidden'); }
        function generateSchedule(type) { callGeminiGeneric(`Role: Coach. Child 5.5yr. Schedule ${type}. Chinese.`, document.getElementById('scheduleResult')); document.getElementById('scheduleResult').classList.remove('hidden'); }
    </script>
</body>
</html>