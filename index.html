<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿ç±³èº«é«˜ç®¡ç† (Final Elite)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Chart Sizing */
        .chart-container { position: relative; width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .nav-tab { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.3s ease; white-space: nowrap; font-size: 0.85rem; }
        .nav-tab.active { border-bottom: 3px solid #0ea5e9; color: #0ea5e9; font-weight: 700; }

        /* Full Screen Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
            z-index: 100; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease-out; }
        .modal-content {
            background: white; width: 95%; max-width: 800px; height: 90%;
            border-radius: 16px; display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }
        
        /* Improved Checkbox Styling */
        .symptom-label { transition: all 0.2s ease; border: 2px solid #e2e8f0; }
        .symptom-checkbox:checked + div { background-color: #ef4444; border-color: #b91c1c; color: white; font-weight: bold; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4); transform: translateY(-1px); }
        .symptom-checkbox:checked + div::after { content: " âœ…"; }
        
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db;
            width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Markdown Styles */
        .prose h3 { color: #0f172a; font-weight: 700; margin-top: 1em; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 0.2em; }
        .prose ul { padding-left: 1.2em; list-style-type: disc; }
        .prose li { margin-bottom: 0.3em; }
        .prose strong { color: #0369a1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased pb-24">

    <!-- Top Bar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="flex justify-between items-center px-4 h-14">
            <div class="font-bold text-sky-600 text-lg">AhMi<span class="text-slate-600">Growth</span> <span class="text-[10px] bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full align-middle">Elite</span></div>
            <div class="flex gap-2">
                <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-sky-600">âš™ï¸</button>
            </div>
        </div>
        
        <div class="flex text-sm font-medium border-t border-slate-100 bg-white shadow-sm overflow-x-auto scrollbar-hide">
            <button onclick="switchMainTab('tracker')" id="nav-tracker" class="nav-tab active flex-1 py-3 px-4 text-center">ğŸ“Š è¿½è¸ª</button>
            <button onclick="switchMainTab('health')" id="nav-health" class="nav-tab flex-1 py-3 px-4 text-center">ğŸ¥ å¥åº·</button>
            <button onclick="switchMainTab('stretch')" id="nav-stretch" class="nav-tab flex-1 py-3 px-4 text-center">ğŸ§˜ æ‹‰ä¼¸</button>
            <button onclick="switchMainTab('ai-diet')" id="nav-ai-diet" class="nav-tab flex-1 py-3 px-4 text-center">ğŸ½ï¸ é£Ÿè°±</button>
            <button onclick="switchMainTab('routine')" id="nav-routine" class="nav-tab flex-1 py-3 px-4 text-center">ğŸ“… æ—¥ç¨‹</button>
        </div>

        <!-- Hidden Settings -->
        <div id="settings-panel" class="hidden absolute left-0 right-0 top-14 bg-white border-b border-slate-200 shadow-xl p-4 z-40">
            <p class="text-xs text-green-600 font-bold mb-2">âœ“ ç³»ç»Ÿå·²å†…ç½®æ‚¨çš„ä¸“å± API Key</p>
            <input type="password" id="apiKeyInput" placeholder="æ‰‹åŠ¨ Key (å¯é€‰)" class="w-full p-2 border border-slate-300 rounded mb-2 text-sm">
            
            <div class="mt-4 pt-4 border-t border-slate-100">
                <p class="text-xs text-slate-500 mb-1">é»˜è®¤å¤‡ä»½é‚®ç®±ï¼š</p>
                <input type="text" value="cheekhan3466@gmail.com" readonly class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-slate-600 text-sm">
            </div>

            <div class="flex gap-2 mt-4">
                <button onclick="saveApiKey()" class="flex-1 bg-sky-600 text-white py-2 rounded text-sm">æ›´æ–°è®¾ç½®</button>
                <button onclick="toggleSettings()" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded text-sm">å…³é—­</button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-6">

        <!-- ========================= TAB 1: TRACKER ========================= -->
        <div id="view-tracker" class="space-y-6 animate-fade-in">
            <!-- AI Control Center -->
            <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-xl p-5 text-white shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-bold">ğŸ¤– AI ç”Ÿé•¿é¡¾é—®</h2>
                        <p class="text-xs text-indigo-100 opacity-90">åŸºäº Simpang Ampat ç¯å¢ƒ & é—ä¼ æ•°æ®</p>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-[10px] font-bold">ç›®æ ‡ 185cm</div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="askGeminiReport('progress')" id="btn-progress" class="bg-white text-indigo-700 hover:bg-indigo-50 py-3 rounded-lg font-bold shadow-md text-sm flex flex-col items-center justify-center gap-1 transition active:scale-95">
                        <span class="text-xl">ğŸ“ˆ</span>
                        <span>åˆ†æè¿›åº¦æŠ¥å‘Š</span>
                    </button>
                    <button onclick="askGeminiReport('rescue')" id="btn-rescue" class="bg-rose-500 text-white hover:bg-rose-600 py-3 rounded-lg font-bold shadow-md text-sm flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-rose-400">
                        <span class="text-xl">ğŸš€</span>
                        <span>å¿«é€Ÿè¡¥æ•‘å»ºè®®</span>
                    </button>
                </div>
            </div>

            <!-- Input Card -->
            <div class="glass-panel p-4 rounded-xl border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-slate-900">ğŸ“ æ•°æ®å½•å…¥</h2>
                    <span id="currentDateDisplay" class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500"></span>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <div><label class="text-[10px] text-slate-500 uppercase">æ—¥æœŸ</label><input type="date" id="recordDate" class="w-full p-2 border rounded text-sm"></div>
                    <div><label class="text-[10px] text-slate-500 uppercase">èº«é«˜ (cm)</label><input type="number" id="recordHeight" step="0.1" placeholder="110" class="w-full p-2 border rounded text-sm font-bold text-indigo-600"></div>
                    <div><label class="text-[10px] text-slate-500 uppercase">ä½“é‡ (kg)</label><input type="number" id="recordWeight" step="0.1" placeholder="18" class="w-full p-2 border rounded text-sm"></div>
                </div>
                <button onclick="addRecord()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold shadow text-sm flex justify-center items-center gap-2 hover:bg-slate-900 transition transform active:scale-95">
                    <span>ğŸ’¾ ä¿å­˜æ•°æ®</span>
                </button>
            </div>

            <!-- Charts -->
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-2">ğŸ“ èº«é«˜æ›²çº¿</h3>
                <div class="chart-container"><canvas id="growthChart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-2">âš–ï¸ ä½“é‡æ›²çº¿</h3>
                <div class="chart-container"><canvas id="weightChart"></canvas></div>
            </div>
            
            <!-- History Table -->
            <div class="glass-panel rounded-xl overflow-hidden border border-slate-200">
                <div class="bg-slate-50 px-4 py-2 text-sm font-bold text-slate-700">å†å²è®°å½•</div>
                <div class="max-h-56 overflow-y-auto">
                    <table class="w-full text-xs text-left" id="recordsTableBody"></table>
                </div>
            </div>
        </div>

        <!-- ========================= TAB 2: HEALTH ========================= -->
        <div id="view-health" class="space-y-6 hidden animate-fade-in">
            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                <h2 class="font-bold text-red-800 mb-2">ğŸ¤’ ç”Ÿç—…è®°å½•ä»ª</h2>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="text-[10px] text-slate-500 uppercase">å¼€å§‹</label><input type="date" id="sickStartDate" class="w-full p-2 border border-red-200 rounded text-sm bg-white"></div>
                    <div><label class="text-[10px] text-slate-500 uppercase">åº·å¤</label><input type="date" id="sickEndDate" class="w-full p-2 border border-red-200 rounded text-sm bg-white"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <label class="cursor-pointer group"><input type="checkbox" class="hidden symptom-checkbox" value="å’³å—½"><div class="symptom-label p-3 rounded-lg text-center text-sm text-slate-600 bg-white group-hover:bg-slate-50">ğŸ˜· å’³å—½</div></label>
                    <label class="cursor-pointer group"><input type="checkbox" class="hidden symptom-checkbox" value="æµé¼»æ¶•"><div class="symptom-label p-3 rounded-lg text-center text-sm text-slate-600 bg-white group-hover:bg-slate-50">ğŸ¤§ æµé¼»æ¶•</div></label>
                    <label class="cursor-pointer group"><input type="checkbox" class="hidden symptom-checkbox" value="å‘çƒ§"><div class="symptom-label p-3 rounded-lg text-center text-sm text-slate-600 bg-white group-hover:bg-slate-50">ğŸ¤’ å‘çƒ§</div></label>
                    <label class="cursor-pointer group"><input type="checkbox" class="hidden symptom-checkbox" value="é¼»å¡"><div class="symptom-label p-3 rounded-lg text-center text-sm text-slate-600 bg-white group-hover:bg-slate-50">ğŸ‘ƒ é¼»å¡</div></label>
                </div>

                <button onclick="addSickRecord()" class="w-full bg-red-500 text-white py-3 rounded-lg font-bold shadow-md text-sm flex justify-center items-center gap-2 hover:bg-red-600 transition transform active:scale-95">
                    <span>ğŸ’¾ ä¿å­˜ç”Ÿç—…è®°å½•</span>
                </button>
            </div>
            
            <div class="glass-panel rounded-xl overflow-hidden border border-slate-200">
                <div class="bg-slate-50 px-4 py-2 text-sm font-bold text-slate-700">å†å²è®°å½•</div>
                <div id="sickRecordsList" class="divide-y divide-slate-100 max-h-80 overflow-y-auto bg-white"></div>
            </div>
        </div>

        <!-- ========================= TAB 3: STRETCH ========================= -->
        <div id="view-stretch" class="space-y-6 hidden animate-fade-in">
            <div class="bg-gradient-to-r from-orange-400 to-amber-500 rounded-xl p-5 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-1">ğŸ§˜ æ¯æ—¥æ‹‰ä¼¸</h2>
                <p class="text-xs text-orange-100">ç¡å‰5åˆ†é’Ÿ = 10å€ç”Ÿé•¿æ¿€ç´ </p>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="bg-amber-50 p-3 border-b border-amber-100"><h3 class="font-bold text-amber-800 text-sm">â˜€ï¸ ç¡é†’å”¤é†’</h3></div>
                <div class="p-4 space-y-4">
                    <div class="flex gap-3"><span class="bg-amber-100 text-amber-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</span><p class="text-xs text-slate-600"><strong>å…¨èº«å»¶å±•:</strong> èººåœ¨åºŠä¸Šï¼Œæ‰‹è„šå‘ç›¸åæ–¹å‘ç”¨åŠ›æ‹‰ä¼¸ 10ç§’ã€‚</p></div>
                    <div class="flex gap-3"><span class="bg-amber-100 text-amber-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</span><p class="text-xs text-slate-600"><strong>ä¾§å¼¯æ‹‰ä¼¸:</strong> ç«™ç«‹ï¼ŒåŒæ‰‹åˆåä¸¾è¿‡å¤´ï¼Œå‘å·¦å³å¼¯è…°æˆCå­—ã€‚</p></div>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="bg-indigo-50 p-3 border-b border-indigo-100"><h3 class="font-bold text-indigo-800 text-sm">ğŸŒ™ ç¡å‰åŠ©é•¿</h3></div>
                <div class="p-4 space-y-4">
                    <div class="flex gap-3"><span class="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</span><p class="text-xs text-slate-600"><strong>æ‘¸è„šå°–:</strong> åç›´è…¿ä¼¸ç›´ï¼Œæ‰‹æ‘¸è„šå°–ã€‚ä¿æŒ 15ç§’ x 2æ¬¡ã€‚</p></div>
                    <div class="flex gap-3"><span class="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</span><p class="text-xs text-slate-600"><strong>å©´å„¿å¼:</strong> è·ªå§¿è¶´ä¸‹ï¼Œæ”¾æ¾è„ŠæŸ±ã€‚ä¿æŒ 30ç§’ã€‚</p></div>
                </div>
            </div>
            <div class="glass-panel p-4 rounded-xl border border-orange-200">
                <h3 class="font-bold text-slate-800 text-sm mb-2">ğŸ¤– AI è¿åŠ¨å»ºè®®</h3>
                <div class="flex gap-2 mb-2">
                    <button onclick="askStretch('fun')" class="flex-1 bg-orange-100 text-orange-700 py-2 rounded text-xs">ğŸ® è¶£å‘³ç‰ˆ</button>
                    <button onclick="askStretch('sore')" class="flex-1 bg-orange-100 text-orange-700 py-2 rounded text-xs">ğŸ¦µ èˆ’ç¼“ç‰ˆ</button>
                </div>
                <div id="stretchResult" class="hidden text-xs text-slate-600 bg-white p-3 rounded border border-slate-200"></div>
            </div>
        </div>

        <!-- ========================= TAB 4: DIET (Updated with Export) ========================= -->
        <div id="view-ai-diet" class="space-y-6 hidden animate-fade-in">
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl p-6 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-2">ğŸ½ï¸ AI åŠ©é•¿é£Ÿè°±</h2>
                <button onclick="generateMealPlan()" id="btnGenMeal" class="w-full bg-white text-emerald-700 py-3 rounded-lg font-bold shadow-md flex justify-center items-center gap-2"><span>âœ¨ ç”Ÿæˆä»Šæ—¥å»ºè®®</span></button>
            </div>
            
            <div id="mealPlanResult" class="hidden">
                <div class="glass-panel p-5 rounded-xl border border-slate-200 prose prose-sm max-w-none prose-emerald mb-4">
                    <div id="mealContent" class="text-slate-700"></div>
                </div>
                
                <!-- NEW: Export to Notes Button -->
                <button onclick="exportRecipeToNotes()" id="btnExportNotes" class="w-full bg-yellow-400 text-yellow-900 py-3 rounded-lg font-bold shadow flex justify-center items-center gap-2 hover:bg-yellow-500 transition">
                    ğŸ“ å­˜å…¥å¤‡å¿˜å½• (Notes)
                </button>
            </div>
        </div>

        <!-- ========================= TAB 5: ROUTINE (CHINESE OUTPUT) ========================= -->
        <div id="view-routine" class="space-y-6 hidden animate-fade-in">
            <div class="bg-indigo-600 rounded-xl p-6 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-2">ğŸ“… æ™ºèƒ½æ—¥ç¨‹</h2>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="generateSchedule('æ­£å¸¸ä¸Šå­¦æ—¥')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ« æ­£å¸¸ä¸Šå­¦æ—¥</button>
                    <button onclick="generateSchedule('å‘¨æœ«/å‡æœŸ')" class="bg-indigo-500 py-2 rounded text-xs">âš½ å‘¨æœ«/å‡æœŸ</button>
                    <button onclick="generateSchedule('è€ƒè¯•å‘¨')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ“š è€ƒè¯•å‘¨</button>
                    <button onclick="generateSchedule('ç”Ÿç—…/ä¼‘æ¯')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ¤’ ç”Ÿç—…/ä¼‘æ¯</button>
                </div>
                <div id="scheduleResult" class="hidden mt-4 bg-white text-slate-800 p-4 rounded-lg text-sm leading-relaxed max-h-64 overflow-y-auto prose prose-sm"></div>
            </div>
        </div>

        <!-- ========================= FULL SCREEN MODAL ========================= -->
        <div id="fullScreenModal" class="modal-overlay">
            <div class="modal-content">
                <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                    <h2 id="modalTitle" class="text-xl font-bold text-slate-800">AI æŠ¥å‘Š</h2>
                    <button onclick="closeModal('fullScreenModal')" class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 hover:bg-slate-300">âœ•</button>
                </div>
                <div id="modalBody" class="p-6 overflow-y-auto flex-1 bg-white prose prose-lg prose-indigo max-w-none"></div>
                <div class="px-6 py-3 border-t border-slate-200 bg-slate-50 flex justify-end">
                    <button onclick="closeModal('fullScreenModal')" class="px-6 py-2 bg-slate-800 text-white rounded-lg font-medium text-sm">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- ========================= SYNC ACTIONS MODAL (NEW) ========================= -->
        <div id="syncActionsModal" class="modal-overlay">
            <div class="modal-content h-auto">
                <div class="px-6 py-4 border-b border-slate-200 bg-indigo-50">
                    <h2 class="text-lg font-bold text-indigo-800">â˜ï¸ æ•°æ®å·²ä¿å­˜ï¼</h2>
                </div>
                <div class="p-6 bg-white space-y-3">
                    <p class="text-sm text-slate-600 mb-2">æ•°æ®å·²ä¿å­˜è‡³æœ¬åœ°å­˜å‚¨ã€‚å»ºè®®ç«‹å³è¿›è¡Œäº‘ç«¯åŒæ­¥æˆ–å¤‡ä»½ï¼š</p>
                    
                    <a id="modalGCalLink" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow">
                        ğŸ“… åŒæ­¥åˆ° Google Calendar
                    </a>
                    
                    <a id="modalEmailLink" href="#" class="flex items-center justify-center gap-2 w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 rounded-lg shadow">
                        ğŸ“§ é‚®ä»¶å‘é€å¤‡ä»½
                    </a>
                    
                    <div class="text-center text-xs text-slate-400 pt-2">
                        é»˜è®¤æ”¶ä»¶äºº: cheekhan3466@gmail.com
                    </div>
                </div>
                <div class="px-6 py-3 border-t border-slate-200 bg-slate-50 flex justify-end">
                    <button onclick="closeModal('syncActionsModal')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded text-sm">å…³é—­</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA & CONFIG ---
        const DEFAULT_API_KEY = "AIzaSyAUtEFAtS0XZOGOgU34583WU2i_MivtJ7s";
        const DEFAULT_EMAIL = "cheekhan3466@gmail.com";
        const CHILD_BIRTH_DATE = new Date('2020-06-01');
        let records = [];
        let sickRecords = [];
        let myChart, weightChart;
        let currentRecipeText = ""; // To store recipe for export

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
            document.getElementById('sickStartDate').value = today;
            document.getElementById('currentDateDisplay').innerText = today;

            loadRecords();
            loadSickRecords();
            initCharts();
            switchMainTab('tracker');
        });

        // --- EMAIL & GCAL SYNC LOGIC ---
        function createGCalLink(title, startDate, endDate, description) {
            const formatGCalDate = (dateStr) => dateStr.replace(/-/g, '');
            const start = formatGCalDate(startDate);
            const end = endDate ? formatGCalDate(endDate) : start; 
            const baseUrl = "https://calendar.google.com/calendar/render?action=TEMPLATE";
            const params = new URLSearchParams();
            params.append('text', title);
            params.append('dates', `${start}/${end}`);
            params.append('details', description + "\n\n(Generated by AhMi Growth App)");
            params.append('sf', 'true');
            params.append('output', 'xml');
            return `${baseUrl}&${params.toString()}`;
        }

        function createMailtoLink(subject, body) {
            return `mailto:${DEFAULT_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function showSyncActions(gCalLink, emailSubject, emailBody) {
            document.getElementById('modalGCalLink').href = gCalLink;
            document.getElementById('modalEmailLink').href = createMailtoLink(emailSubject, emailBody);
            document.getElementById('syncActionsModal').classList.add('open');
        }

        // --- TRACKER LOGIC ---
        function loadRecords() {
            const stored = localStorage.getItem('ahmi_growth_records');
            records = stored ? JSON.parse(stored) : [{ id: 1, date: '2025-05-01', age: 5.5, height: 110, weight: 18 }];
            renderTable(); updateCharts();
        }

        function addRecord() {
            const date = document.getElementById('recordDate').value;
            const h = parseFloat(document.getElementById('recordHeight').value);
            const w = parseFloat(document.getElementById('recordWeight').value);
            if(!date || !h || !w) return alert('è¯·å¡«å†™');
            
            const age = (new Date(date) - CHILD_BIRTH_DATE) / (1000 * 60 * 60 * 24 * 365.25);
            const newRecord = {id:Date.now(), date, age: age.toFixed(1), height:h, weight:w};
            records.push(newRecord);
            localStorage.setItem('ahmi_growth_records', JSON.stringify(records)); 
            loadRecords();

            // Prepare Sync Data
            const title = `ã€é˜¿ç±³èº«é«˜ã€‘${h}cm / ${w}kg`;
            const desc = `å¹´é¾„: ${age.toFixed(1)}å²\nBMI: ${(w/((h/100)**2)).toFixed(1)}\nç›®æ ‡: 185cm`;
            const gCalLink = createGCalLink(title, date, null, desc);
            
            const emailSub = `é˜¿ç±³èº«é«˜è®°å½•å¤‡ä»½ - ${date}`;
            const emailBody = `æ—¥æœŸ: ${date}\nèº«é«˜: ${h}cm\nä½“é‡: ${w}kg\nå¹´é¾„: ${age.toFixed(1)}å²\n\n(æ­¤é‚®ä»¶ç”± AhMi Growth App è‡ªåŠ¨ç”Ÿæˆ)`;

            showSyncActions(gCalLink, emailSub, emailBody);
        }

        function renderTable() {
            const tbody = document.getElementById('recordsTableBody'); tbody.innerHTML='';
            [...records].reverse().forEach(r => {
                tbody.innerHTML += `
                <tr class="border-b border-slate-50">
                    <td class="px-3 py-2">${r.date}</td>
                    <td class="px-3 py-2 font-bold text-indigo-600">${r.height}cm / ${r.weight}kg</td>
                </tr>`;
            });
        }

        // --- HEALTH LOGIC ---
        function loadSickRecords() {
            const stored = localStorage.getItem('ahmi_sick_records');
            if (stored) { sickRecords = JSON.parse(stored); sickRecords.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate)); }
            renderSickTable();
        }

        function addSickRecord() {
            const start = document.getElementById('sickStartDate').value;
            const end = document.getElementById('sickEndDate').value;
            const sym = []; document.querySelectorAll('.symptom-checkbox:checked').forEach(c=>sym.push(c.value));
            if(!start || sym.length===0) return alert('è¯·å¡«å†™');
            
            sickRecords.push({id:Date.now(), startDate:start, endDate:end||"æœªåº·å¤", symptoms:sym});
            localStorage.setItem('ahmi_sick_records', JSON.stringify(sickRecords)); loadSickRecords();
            document.querySelectorAll('.symptom-checkbox').forEach(c=>c.checked=false);

            // Prepare Sync Data
            const title = `ã€é˜¿ç±³å¥åº·ã€‘ç”Ÿç—…: ${sym.join(',')}`;
            const gCalLink = createGCalLink(title, start, end || start, "ç”Ÿç—…è®°å½•ã€‚è¯·æ³¨æ„ä¼‘æ¯ã€‚");
            
            const emailSub = `é˜¿ç±³ç”Ÿç—…è®°å½•å¤‡ä»½ - ${start}`;
            const emailBody = `å¼€å§‹æ—¥æœŸ: ${start}\nç»“æŸæ—¥æœŸ: ${end || 'æœªåº·å¤'}\nç—‡çŠ¶: ${sym.join(', ')}\n\n(æ­¤é‚®ä»¶ç”± AhMi Growth App è‡ªåŠ¨ç”Ÿæˆ)`;

            showSyncActions(gCalLink, emailSub, emailBody);
        }

        function renderSickTable() {
            const div = document.getElementById('sickRecordsList'); div.innerHTML='';
            if(sickRecords.length===0) return div.innerHTML='<div class="p-4 text-center text-xs text-slate-400">æš‚æ— ç”Ÿç—…è®°å½•</div>';
            sickRecords.forEach(r => {
                div.innerHTML += `
                <div class="p-3 border-b border-slate-50 flex justify-between items-center">
                    <div class="text-xs">
                        <b>${r.startDate}</b> <span class="text-slate-400">è‡³</span> ${r.endDate} <br>
                        <span class="text-red-500 font-medium">${r.symptoms.join(', ')}</span>
                    </div>
                    <button onclick="deleteSick(${r.id})" class="text-red-300 text-[10px]">Ã—</button>
                </div>`;
            });
        }

        // --- EXPORT TO NOTES LOGIC ---
        function exportRecipeToNotes() {
            if (!currentRecipeText) return alert("è¯·å…ˆç”Ÿæˆé£Ÿè°±ï¼");

            const today = new Date().toISOString().split('T')[0];
            const cleanText = currentRecipeText.replace(/[*#]/g, ''); 
            const exportTitle = `é˜¿ç±³é£Ÿè°± - ${today}`;
            const exportBody = `${exportTitle}\n\n${cleanText}\n\n(æ¥è‡ª AhMi Growth App)`;

            if (navigator.share) {
                navigator.share({
                    title: exportTitle,
                    text: exportBody
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(exportBody).then(() => {
                    alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nè¯·æ‰“å¼€å¤‡å¿˜å½• (Notes) ç²˜è´´ã€‚");
                });
            }
        }

        // --- OTHER LOGIC (TABS, AI, CHARTS) ---
        function switchMainTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
            ['tracker', 'health', 'stretch', 'ai-diet', 'routine'].forEach(id => document.getElementById('view-' + id).classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');
            if(tabId === 'tracker') { if(myChart) myChart.resize(); if(weightChart) weightChart.resize(); }
        }
        function getApiKey() { return localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY; }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow = ''; }
        function openModal(title, text) { document.getElementById('modalTitle').innerText = title; document.getElementById('modalBody').innerHTML = marked.parse(text); document.getElementById('fullScreenModal').classList.add('open'); document.body.style.overflow = 'hidden'; }
        
        async function askGeminiReport(type) {
            if (records.length === 0) return alert("è¯·å…ˆå½•å…¥èº«é«˜ä½“é‡æ•°æ®");
            const apiKey = getApiKey();
            const latest = records[records.length - 1];
            const btnId = type === 'progress' ? 'btn-progress' : 'btn-rescue';
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>'; btn.disabled = true;
            let prompt = ""; let title = "";
            if (type === 'progress') { title = "ğŸ“ˆ åŒè¯­ç”Ÿé•¿è¿›åº¦æŠ¥å‘Š / Dual-Language Progress Report"; prompt = `Role: Pediatric Specialist. Child Age ${latest.age}, Height ${latest.height}cm, Weight ${latest.weight}kg. Target 185cm. Context: Penang. Task: Dual-language report (Chinese & English) analyzing percentile, BMI, and status. Markdown format.`; } 
            else { title = "ğŸš€ å¿«é€Ÿè¡¥æ•‘æ–¹æ¡ˆ / Quick Rescue Plan"; prompt = `Role: Growth Crisis Specialist. Child Age ${latest.age}, Height ${latest.height}cm, Weight ${latest.weight}kg. Target 185cm. Situation: Lagging growth. Task: Dual-language (Chinese & English) rescue plan focusing on Penang diet, sleep, and HIIT sports. Markdown format.`; }
            try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); const data = await response.json(); openModal(title, data.candidates[0].content.parts[0].text); } catch (e) { alert("AI Error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }
        function initCharts() {
            const ages = [5,6,7,8,9,10,11,12,13,14];
            myChart = new Chart(document.getElementById('growthChart'), { type:'line', data:{labels:ages, datasets:[{label:'å®æµ‹',data:[],borderColor:'#8b5cf6'}, {label:'ç›®æ ‡',data:[110,115,122,129,135,141,148,156,166,175],borderColor:'#0ea5e9',borderDash:[5,5]}]}, options:{maintainAspectRatio:false} });
            weightChart = new Chart(document.getElementById('weightChart'), { type:'line', data:{labels:ages, datasets:[{label:'å®æµ‹',data:[],borderColor:'#f59e0b'}, {label:'æ ‡å‡†',data:[18,20,23,25,28,32,36,40,45,50],borderColor:'#10b981',borderDash:[5,5]}]}, options:{maintainAspectRatio:false} });
        }
        function updateCharts() { if(!myChart)return; myChart.data.datasets[0].data=records.map(r=>r.height); myChart.update(); weightChart.data.datasets[0].data=records.map(r=>r.weight); weightChart.update(); }
        function deleteSick(id) { sickRecords=sickRecords.filter(r=>r.id!==id); localStorage.setItem('ahmi_sick_records', JSON.stringify(sickRecords)); renderSickTable(); }
        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function saveApiKey() { localStorage.setItem('gemini_api_key', document.getElementById('apiKeyInput').value); toggleSettings(); }
        
        // Generic AI with Text Capture
        async function callGeminiGeneric(prompt, outputContainer, btn, captureGlobal = false) {
            const apiKey = getApiKey(); if(btn) { btn.disabled=true; btn.innerHTML='<div class="loader"></div>'; } outputContainer.classList.remove('hidden'); outputContainer.innerHTML = 'AI Thinking...';
            try { 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); 
                const data = await response.json(); 
                const text = data.candidates[0].content.parts[0].text;
                outputContainer.innerHTML = marked.parse(text); 
                if(captureGlobal) currentRecipeText = text; // Capture for export
            } catch (e) { outputContainer.innerHTML = "Error."; } 
            if(btn) { btn.disabled=false; btn.innerHTML='âœ¨ ç”Ÿæˆ'; }
        }
        function askStretch(type) { callGeminiGeneric(`Role: Kids Physio. Child 5.5yr. ${type==='fun'?'Fun game':'Sore relief'} stretching. Chinese.`, document.getElementById('stretchResult')); }
        function generateMealPlan() { 
            callGeminiGeneric(`Role: Nutritionist. Child 5.5yr. Penang food. 1 Day Meal Plan. Markdown. Chinese.`, document.getElementById('mealContent'), document.getElementById('btnGenMeal'), true); 
            document.getElementById('mealPlanResult').classList.remove('hidden'); 
        }
        
        // UPDATED: Strictly Chinese Schedule
        function generateSchedule(type) { 
            callGeminiGeneric(`Role: Pediatric Growth Coach. Context: Simpang Ampat, Penang. Child: 5.5 years old. Scenario: ${type}. Task: Create a detailed daily schedule focusing on 9:30PM sleep, 5PM outdoor sports, and meals. Language: Output ONLY in Chinese (Simplified Mandarin).`, document.getElementById('scheduleResult')); 
            document.getElementById('scheduleResult').classList.remove('hidden'); 
        }
    </script>
</body>
</html>