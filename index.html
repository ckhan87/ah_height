<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿ç±³èº«é«˜ç®¡ç† AI ç»ˆæç‰ˆ (å«å¥åº·è®°å½•)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Mobile Chart Fix */
        .chart-container { position: relative; width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Navigation Tabs Styling */
        .nav-tab {
            border-bottom: 3px solid transparent;
            color: #64748b;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        .nav-tab.active { border-bottom: 3px solid #0ea5e9; color: #0ea5e9; font-weight: 700; }

        /* Inner Content Tabs */
        .stage-tab { border: 1px solid transparent; background: #f1f5f9; color: #64748b; }
        .stage-tab.active { background: #fff; border-color: #e2e8f0; color: #0284c7; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Checkbox Styling */
        .symptom-checkbox:checked + div { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Markdown Styles */
        .prose h3 { color: #0f172a; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; font-size: 1.1em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.3em; }
        .prose strong { color: #0369a1; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased pb-24">

    <!-- Top Bar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="flex justify-between items-center px-4 h-14">
            <div class="font-bold text-sky-600 text-lg">AhMi<span class="text-slate-600">Health</span> <span class="text-[10px] bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full align-middle">Pro</span></div>
            <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-sky-600">âš™ï¸</button>
        </div>
        
        <!-- Main Tab Navigation (Scrollable) -->
        <div class="flex text-sm font-medium border-t border-slate-100 bg-white shadow-sm overflow-x-auto scrollbar-hide">
            <button onclick="switchMainTab('tracker')" id="nav-tracker" class="nav-tab active flex-1 py-3 px-4 text-center">
                ğŸ“Š è¿½è¸ª
            </button>
            <button onclick="switchMainTab('health')" id="nav-health" class="nav-tab flex-1 py-3 px-4 text-center">
                ğŸ¥ ç”Ÿç—…è®°å½•
            </button>
            <button onclick="switchMainTab('stretch')" id="nav-stretch" class="nav-tab flex-1 py-3 px-4 text-center">
                ğŸ§˜ æ‹‰ä¼¸
            </button>
            <button onclick="switchMainTab('ai-diet')" id="nav-ai-diet" class="nav-tab flex-1 py-3 px-4 text-center">
                ğŸ½ï¸ é£Ÿè°±
            </button>
            <button onclick="switchMainTab('routine')" id="nav-routine" class="nav-tab flex-1 py-3 px-4 text-center">
                ğŸ“… æ—¥ç¨‹
            </button>
        </div>

        <!-- Hidden Settings Panel -->
        <div id="settings-panel" class="hidden absolute left-0 right-0 top-14 bg-white border-b border-slate-200 shadow-xl p-4 z-40">
            <p class="text-xs text-green-600 font-bold mb-2">âœ“ ç³»ç»Ÿå·²å†…ç½®æ‚¨çš„ä¸“å± API Key</p>
            <input type="password" id="apiKeyInput" placeholder="æ‰‹åŠ¨ Key (å¯é€‰)" class="w-full p-2 border border-slate-300 rounded mb-2 text-sm">
            <div class="flex gap-2">
                <button onclick="saveApiKey()" class="flex-1 bg-sky-600 text-white py-2 rounded text-sm">æ›´æ–°</button>
                <button onclick="toggleSettings()" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded text-sm">å…³é—­</button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-6">

        <!-- ========================= TAB 1: TRACKER (èº«é«˜ä½“é‡) ========================= -->
        <div id="view-tracker" class="space-y-6 animate-fade-in">
            <!-- Input Card -->
            <div class="glass-panel p-4 rounded-xl border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-slate-900">ğŸ“ ç”Ÿé•¿å½•å…¥</h2>
                    <span id="currentDateDisplay" class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500"></span>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase">æ—¥æœŸ</label>
                        <input type="date" id="recordDate" class="w-full p-2 border rounded text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase">èº«é«˜ (cm)</label>
                        <input type="number" id="recordHeight" step="0.1" placeholder="110" class="w-full p-2 border rounded text-sm font-bold text-indigo-600">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase">ä½“é‡ (kg)</label>
                        <input type="number" id="recordWeight" step="0.1" placeholder="18" class="w-full p-2 border rounded text-sm">
                    </div>
                </div>
                <button onclick="addRecord()" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-bold shadow text-sm">ä¿å­˜æ•°æ®</button>
            </div>

            <!-- Charts -->
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-2">ğŸ“ èº«é«˜æ›²çº¿ (ç›®æ ‡ 185)</h3>
                <div class="chart-container"><canvas id="growthChart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-2">âš–ï¸ ä½“é‡æ›²çº¿</h3>
                <div class="chart-container"><canvas id="weightChart"></canvas></div>
            </div>
            
            <!-- AI Analysis -->
            <div class="glass-panel p-4 rounded-xl border border-sky-200 bg-sky-50/30">
                <button onclick="askGeminiProgress()" id="aiProgressBtn" class="w-full py-2 bg-white border border-sky-200 text-sky-700 rounded text-sm font-medium shadow-sm">âœ¨ AI åˆ†æç”Ÿé•¿è¿›åº¦</button>
                <div id="aiProgressArea" class="mt-2 text-xs text-slate-600 hidden"></div>
            </div>

            <!-- History Table -->
            <div class="glass-panel rounded-xl overflow-hidden border border-slate-200">
                <div class="bg-slate-50 px-4 py-2 text-sm font-bold text-slate-700">å†å²è®°å½•</div>
                <div class="max-h-48 overflow-y-auto">
                    <table class="w-full text-xs text-left" id="recordsTableBody"></table>
                </div>
            </div>
        </div>

        <!-- ========================= TAB 2: HEALTH (ç”Ÿç—…è®°å½•) - NEW ========================= -->
        <div id="view-health" class="space-y-6 hidden animate-fade-in">
            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                <h2 class="font-bold text-red-800 mb-2 flex items-center gap-2">
                    <span>ğŸ¤’ ç”Ÿç—…è®°å½•ä»ª</span>
                </h2>
                <p class="text-xs text-red-600 mb-4">è®°å½•ç”Ÿç—…æ—¶é•¿ï¼Œç›‘æ§æŠµæŠ—åŠ›ã€‚ç”Ÿç—…æœŸé—´ç”Ÿé•¿ä¼šæš‚åœï¼Œéœ€åœ¨åº·å¤åè¡¥è¥å…»ã€‚</p>
                
                <!-- Date Inputs -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase">å¼€å§‹ç”Ÿç—…</label>
                        <input type="date" id="sickStartDate" class="w-full p-2 border border-red-200 rounded text-sm bg-white">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase">åº·å¤æ—¥æœŸ</label>
                        <input type="date" id="sickEndDate" class="w-full p-2 border border-red-200 rounded text-sm bg-white">
                    </div>
                </div>

                <!-- Symptom Selector (Multi-select) -->
                <label class="text-[10px] text-slate-500 uppercase block mb-2">ç—‡çŠ¶ (å¯å¤šé€‰)</label>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <label class="cursor-pointer">
                        <input type="checkbox" class="hidden symptom-checkbox" value="å’³å—½">
                        <div class="p-2 border border-slate-200 rounded text-center text-sm text-slate-600 bg-white hover:bg-slate-50 transition">ğŸ˜· å’³å—½</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="checkbox" class="hidden symptom-checkbox" value="æµé¼»æ¶•">
                        <div class="p-2 border border-slate-200 rounded text-center text-sm text-slate-600 bg-white hover:bg-slate-50 transition">ğŸ¤§ æµé¼»æ¶•</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="checkbox" class="hidden symptom-checkbox" value="å‘çƒ§">
                        <div class="p-2 border border-slate-200 rounded text-center text-sm text-slate-600 bg-white hover:bg-slate-50 transition">ğŸ¤’ å‘çƒ§</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="checkbox" class="hidden symptom-checkbox" value="é¼»å¡">
                        <div class="p-2 border border-slate-200 rounded text-center text-sm text-slate-600 bg-white hover:bg-slate-50 transition">ğŸ‘ƒ é¼»å¡</div>
                    </label>
                </div>

                <button onclick="addSickRecord()" class="w-full bg-red-500 text-white py-2 rounded-lg font-bold shadow text-sm hover:bg-red-600">ä¿å­˜ç”Ÿç—…è®°å½•</button>
            </div>

            <!-- Sick History List -->
            <div class="glass-panel rounded-xl overflow-hidden border border-slate-200">
                <div class="bg-slate-50 px-4 py-2 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 text-sm">ç”Ÿç—…å†å²</h3>
                    <span class="text-[10px] text-slate-400">æœ¬åœ°å­˜å‚¨</span>
                </div>
                <div id="sickRecordsList" class="divide-y divide-slate-100 max-h-80 overflow-y-auto bg-white">
                    <!-- JS Injected -->
                    <div class="p-4 text-center text-slate-400 text-xs">æš‚æ— ç”Ÿç—…è®°å½•ï¼Œé˜¿ç±³èº«ä½“å¾ˆæ£’ï¼</div>
                </div>
            </div>
        </div>

        <!-- ========================= TAB 3: STRETCH (æ‹‰ä¼¸) - NEW ========================= -->
        <div id="view-stretch" class="space-y-6 hidden animate-fade-in">
            <div class="bg-gradient-to-r from-orange-400 to-amber-500 rounded-xl p-5 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-1">ğŸ§˜ æ¯æ—¥æ‹‰ä¼¸è®¡åˆ’</h2>
                <p class="text-xs text-orange-100 mb-0">æ‹‰å¼€éª¨éªºé—´éš™ï¼Œæ¯æ™šå¤šé•¿ 0.5mm</p>
            </div>

            <!-- Morning Routine -->
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="bg-amber-50 p-3 border-b border-amber-100 flex items-center gap-2">
                    <span class="text-xl">â˜€ï¸</span>
                    <h3 class="font-bold text-amber-800 text-sm">ç¡é†’å”¤é†’ (3åˆ†é’Ÿ)</h3>
                </div>
                <div class="p-4 space-y-4">
                    <div class="flex gap-3 items-start">
                        <div class="bg-amber-100 text-amber-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</div>
                        <div>
                            <h4 class="font-bold text-sm text-slate-800">åºŠä¸Šå…¨èº«å»¶å±•</h4>
                            <p class="text-xs text-slate-500">èººåœ¨åºŠä¸Šï¼ŒåŒæ‰‹æ‰‹æŒ‡äº¤å‰å‘ä¸Šæ¨ï¼Œè„šå°–å‘ä¸‹å‹ã€‚åƒè¦æŠŠèº«ä½“æ‹‰æˆä¸€æ¡çº¿ã€‚ä¿æŒ 10ç§’ x 3æ¬¡ã€‚</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="bg-amber-100 text-amber-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</div>
                        <div>
                            <h4 class="font-bold text-sm text-slate-800">Cå­—æ‹‰ä¼¸</h4>
                            <p class="text-xs text-slate-500">ç«™ç«‹ï¼ŒåŒæ‰‹åˆåä¸¾è¿‡å¤´é¡¶ï¼Œå‘å·¦å¼¯è…°æˆCå­—ï¼Œå†å‘å³ã€‚æ‹‰ä¼¸ä¾§è…¹ã€‚å„åœ 5ç§’ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Night Routine -->
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="bg-indigo-50 p-3 border-b border-indigo-100 flex items-center gap-2">
                    <span class="text-xl">ğŸŒ™</span>
                    <h3 class="font-bold text-indigo-800 text-sm">ç¡å‰åŠ©é•¿ (5åˆ†é’Ÿ)</h3>
                </div>
                <div class="p-4 space-y-4">
                    <div class="flex gap-3 items-start">
                        <div class="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</div>
                        <div>
                            <h4 class="font-bold text-sm text-slate-800">å©´å„¿å¼ (Child's Pose)</h4>
                            <p class="text-xs text-slate-500">è·ªåœ¨åºŠä¸Šï¼Œå±è‚¡ååœ¨è„šåè·Ÿï¼ŒåŒæ‰‹å‘å‰è¶´ä¸‹å»¶ä¼¸ã€‚æ”¾æ¾è„ŠæŸ±ã€‚ä¿æŒ 30ç§’ã€‚</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</div>
                        <div>
                            <h4 class="font-bold text-sm text-slate-800">åä½ä½“å‰å±ˆ (æ‘¸è„šå°–)</h4>
                            <p class="text-xs text-slate-500">ååœ¨åºŠä¸Šè…¿ä¼¸ç›´ï¼Œæ‰‹å°½é‡å»æ‘¸è„šå°–ã€‚ä¸è¦å‹‰å¼ºï¼Œæ‹‰åˆ°å¤§è…¿åä¾§æœ‰æ„Ÿè§‰å³å¯ã€‚ä¿æŒ 15ç§’ x 2æ¬¡ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Coach -->
            <div class="glass-panel p-4 rounded-xl border border-orange-200">
                <h3 class="font-bold text-slate-800 text-sm mb-2">ğŸ¤– AI è¿åŠ¨ç§æ•™</h3>
                <p class="text-xs text-slate-500 mb-3">ä»Šå¤©æœ‰ç‰¹æ®Šæƒ…å†µï¼Ÿ(å¦‚ï¼šè…¿é…¸ã€ä¸æƒ³åŠ¨ã€æƒ³åšæ¸¸æˆ)</p>
                <div class="flex gap-2 mb-3">
                    <button onclick="askStretch('fun')" class="flex-1 bg-orange-100 text-orange-700 py-2 rounded text-xs hover:bg-orange-200">ğŸ® è¶£å‘³æ¸¸æˆç‰ˆ</button>
                    <button onclick="askStretch('sore')" class="flex-1 bg-orange-100 text-orange-700 py-2 rounded text-xs hover:bg-orange-200">ğŸ¦µ è…¿é…¸èˆ’ç¼“ç‰ˆ</button>
                </div>
                <div id="stretchResult" class="hidden bg-white p-3 rounded border border-slate-200 text-xs text-slate-600"></div>
            </div>
        </div>

        <!-- ========================= TAB 4: AI DIET (é£Ÿè°±) ========================= -->
        <div id="view-ai-diet" class="space-y-6 hidden animate-fade-in">
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl p-6 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-2">ğŸ½ï¸ AI åŠ©é•¿é£Ÿè°±</h2>
                <button onclick="generateMealPlan()" id="btnGenMeal" class="w-full bg-white text-emerald-700 py-3 rounded-lg font-bold shadow-md flex justify-center items-center gap-2">
                    <span>âœ¨ ç”Ÿæˆä»Šæ—¥é£Ÿè°±</span>
                </button>
            </div>
            <div id="mealPlanResult" class="hidden glass-panel p-5 rounded-xl border border-slate-200 prose prose-sm max-w-none prose-emerald">
                <div id="mealContent" class="text-slate-700"></div>
            </div>
        </div>

        <!-- ========================= TAB 5: ROUTINE (æ—¥ç¨‹) ========================= -->
        <div id="view-routine" class="space-y-6 hidden animate-fade-in">
            <div class="bg-indigo-600 rounded-xl p-6 text-white shadow-lg">
                <h2 class="text-xl font-bold mb-2">ğŸ“… æ™ºèƒ½æ—¥ç¨‹é¡¾é—®</h2>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="generateSchedule('normal')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ« æ­£å¸¸ä¸Šå­¦</button>
                    <button onclick="generateSchedule('weekend')" class="bg-indigo-500 py-2 rounded text-xs">âš½ å‘¨æœ«/å‡æœŸ</button>
                    <button onclick="generateSchedule('exam')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ“š è€ƒè¯•å‘¨</button>
                    <button onclick="generateSchedule('sick')" class="bg-indigo-500 py-2 rounded text-xs">ğŸ¤’ ç”Ÿç—…/ä¼‘æ¯</button>
                </div>
                <div id="scheduleResult" class="hidden mt-4 bg-white text-slate-800 p-4 rounded-lg text-sm leading-relaxed max-h-64 overflow-y-auto"></div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA & CONFIG ---
        const DEFAULT_API_KEY = "AIzaSyAUtEFAtS0XZOGOgU34583WU2i_MivtJ7s";
        const CHILD_BIRTH_DATE = new Date('2020-06-01');
        let records = [];
        let sickRecords = [];
        let myChart, weightChart;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
            document.getElementById('sickStartDate').value = today;
            document.getElementById('currentDateDisplay').innerText = today;

            loadRecords();
            loadSickRecords();
            initCharts();
            switchMainTab('tracker');
        });

        // --- TABS ---
        function switchMainTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
            
            ['tracker', 'health', 'stretch', 'ai-diet', 'routine'].forEach(id => {
                document.getElementById('view-' + id).classList.add('hidden');
            });
            document.getElementById('view-' + tabId).classList.remove('hidden');

            if(tabId === 'tracker') {
                if(myChart) myChart.resize();
                if(weightChart) weightChart.resize();
            }
        }

        // --- HEALTH / SICKNESS LOGIC ---
        function loadSickRecords() {
            const stored = localStorage.getItem('ahmi_sick_records');
            if (stored) {
                sickRecords = JSON.parse(stored);
                sickRecords.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)); // Newest first
            }
            renderSickTable();
        }

        function addSickRecord() {
            const start = document.getElementById('sickStartDate').value;
            const end = document.getElementById('sickEndDate').value;
            
            // Get Checkboxes
            const symptoms = [];
            document.querySelectorAll('.symptom-checkbox:checked').forEach(cb => {
                symptoms.push(cb.value);
            });

            if(!start || symptoms.length === 0) {
                alert("è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œè‡³å°‘ä¸€ç§ç—‡çŠ¶");
                return;
            }

            sickRecords.push({
                id: Date.now(),
                startDate: start,
                endDate: end || "æœªåº·å¤",
                symptoms: symptoms
            });

            localStorage.setItem('ahmi_sick_records', JSON.stringify(sickRecords));
            loadSickRecords(); // Refresh sort & render
            
            // Reset form
            document.querySelectorAll('.symptom-checkbox').forEach(cb => cb.checked = false);
            alert("ç”Ÿç—…è®°å½•å·²ä¿å­˜ã€‚");
        }

        function deleteSickRecord(id) {
            if(confirm('åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ')) {
                sickRecords = sickRecords.filter(r => r.id !== id);
                localStorage.setItem('ahmi_sick_records', JSON.stringify(sickRecords));
                renderSickTable();
            }
        }

        function renderSickTable() {
            const container = document.getElementById('sickRecordsList');
            container.innerHTML = '';

            if(sickRecords.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs">æš‚æ— ç”Ÿç—…è®°å½•ï¼Œé˜¿ç±³èº«ä½“å¾ˆæ£’ï¼</div>';
                return;
            }

            sickRecords.forEach(r => {
                // Calculate duration
                let durationStr = "è¿›è¡Œä¸­";
                let days = 0;
                if (r.endDate && r.endDate !== "æœªåº·å¤") {
                    const start = new Date(r.startDate);
                    const end = new Date(r.endDate);
                    const diffTime = Math.abs(end - start);
                    days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // Include start day
                    durationStr = `${days} å¤©`;
                }

                // Tags for symptoms
                const tags = r.symptoms.map(s => {
                    let color = 'bg-slate-100 text-slate-600';
                    if(s === 'å‘çƒ§') color = 'bg-red-100 text-red-600';
                    if(s === 'å’³å—½') color = 'bg-orange-100 text-orange-600';
                    return `<span class="px-2 py-0.5 rounded-full text-[10px] ${color} mr-1">${s}</span>`;
                }).join('');

                const div = document.createElement('div');
                div.className = "p-3 flex justify-between items-start hover:bg-slate-50";
                div.innerHTML = `
                    <div>
                        <div class="text-xs font-bold text-slate-800 mb-1">
                            ${r.startDate} <span class="text-slate-400 font-normal">è‡³</span> ${r.endDate}
                        </div>
                        <div class="flex flex-wrap">${tags}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-slate-500 mb-1">${durationStr}</div>
                        <button onclick="deleteSickRecord(${r.id})" class="text-[10px] text-red-300 hover:text-red-500">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- AI STRETCH LOGIC ---
        async function askStretch(type) {
            let context = "";
            if (type === 'fun') context = "Make it a game/fun challenge.";
            if (type === 'sore') context = "Child has sore legs from sports. Needs gentle relief.";
            
            const prompt = `
                Role: Kids Physiotherapist.
                Child: 5.5 years old.
                Context: Simpang Ampat.
                Request: ${context} Give 2 specific stretching exercises suitable for waking up or sleeping.
                Format: Markdown list. Chinese Simplified.
            `;
            
            const div = document.getElementById('stretchResult');
            div.classList.remove('hidden');
            div.innerHTML = "<div class='loader inline-block'></div> AI æ€è€ƒä¸­...";
            
            await callGeminiGeneric(prompt, div);
        }

        // --- SHARED API UTILS ---
        function getApiKey() {
            return localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY;
        }

        async function callGeminiGeneric(prompt, outputContainer) {
            const apiKey = getApiKey();
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                outputContainer.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
            } catch (error) {
                outputContainer.innerHTML = "Error: " + error.message;
            }
        }

        // --- DIET & SCHEDULE & TRACKER RE-IMPLEMENTATION ---
        // (Similar to previous version logic, condensed for brevity)
        function generateMealPlan() {
             const btn = document.getElementById('btnGenMeal');
             const div = document.getElementById('mealContent');
             document.getElementById('mealPlanResult').classList.remove('hidden');
             btn.disabled = true; btn.innerHTML = "â³...";
             
             const prompt = `Role: Nutritionist. Child 5.5yr. Penang local food. Task: 1 Day Meal Plan (Breakfast/Dinner) for height. Format: Markdown. Chinese.`;
             callGeminiGeneric(prompt, div).then(() => { btn.disabled = false; btn.innerHTML = "âœ¨ ç”Ÿæˆä»Šæ—¥é£Ÿè°±"; });
        }

        function generateSchedule(type) {
            const div = document.getElementById('scheduleResult');
            div.classList.remove('hidden'); div.innerHTML = "â³...";
            const prompt = `Role: Growth Coach. Child 5.5yr. Simpang Ampat. Schedule type: ${type}. List format. Chinese.`;
            callGeminiGeneric(prompt, div);
        }

        function askGeminiProgress() {
            const div = document.getElementById('aiProgressArea');
            div.classList.remove('hidden'); div.innerHTML = "â³...";
            if (records.length === 0) return div.innerHTML = "è¯·å…ˆå½•å…¥æ•°æ®";
            const last = records[records.length-1];
            const prompt = `Analyze child growth: 5.5yr, ${last.height}cm, ${last.weight}kg. Target 185. Chinese.`;
            callGeminiGeneric(prompt, div);
        }

        // --- TRACKER DATA ---
        function loadRecords() {
            const stored = localStorage.getItem('ahmi_growth_records');
            records = stored ? JSON.parse(stored) : [{ id: 1, date: '2025-05-01', age: 5.5, height: 110, weight: 18 }];
            renderTable(); updateCharts();
        }
        function addRecord() {
            const date = document.getElementById('recordDate').value;
            const h = parseFloat(document.getElementById('recordHeight').value);
            const w = parseFloat(document.getElementById('recordWeight').value);
            if(!date || !h || !w) return alert('è¯·å®Œæ•´å¡«å†™');
            records.push({id:Date.now(), date, age:5.5, height:h, weight:w}); // Simplified age calc for demo
            localStorage.setItem('ahmi_growth_records', JSON.stringify(records));
            loadRecords();
        }
        function renderTable() {
            const tbody = document.getElementById('recordsTableBody'); tbody.innerHTML='';
            [...records].reverse().forEach(r => {
                tbody.innerHTML += `<tr class="border-b border-slate-50"><td class="px-3 py-2">${r.date}</td><td class="px-3 py-2 font-bold text-indigo-600">${r.height}cm / ${r.weight}kg</td></tr>`;
            });
        }
        function initCharts() {
            const ages = [5,6,7,8,9,10,11,12];
            myChart = new Chart(document.getElementById('growthChart'), {
                type:'line', data:{labels:ages, datasets:[{label:'å®æµ‹',data:[],borderColor:'#8b5cf6'}, {label:'ç›®æ ‡',data:[110,115,122,129,135,141,148,156],borderColor:'#0ea5e9',borderDash:[5,5]}]},
                options:{maintainAspectRatio:false}
            });
            weightChart = new Chart(document.getElementById('weightChart'), {
                type:'line', data:{labels:ages, datasets:[{label:'å®æµ‹',data:[],borderColor:'#f59e0b'}, {label:'æ ‡å‡†',data:[18,20,23,25,28,32,36,40],borderColor:'#10b981',borderDash:[5,5]}]},
                options:{maintainAspectRatio:false}
            });
        }
        function updateCharts() {
            if(!myChart) return;
            myChart.data.datasets[0].data = records.map(r=>r.height); myChart.update();
            weightChart.data.datasets[0].data = records.map(r=>r.weight); weightChart.update();
        }
        
        // --- SETTINGS ---
        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function saveApiKey() { localStorage.setItem('gemini_api_key', document.getElementById('apiKeyInput').value); toggleSettings(); }

    </script>
</body>
</html>